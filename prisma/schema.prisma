// Trình sinh Prisma Client
generator client {
  provider = "prisma-client-js"
  // Sinh client vào thư mục `generated/prisma` ở root project để phù hợp với import
  // đường dẫn ../../generated/prisma từ thư mục src/base
  output   = "../generated/prisma"
}

// Datasource: cấu hình kết nối DB.
// Mặc định ở đây dùng Postgres (thích hợp với Supabase). Nếu muốn phát triển local
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -------------------------
// Các model (bảng)
// -------------------------

// User: thiết kế để dễ mở rộng và liên kết với Supabase Auth thông qua `supabaseId` (UUID)
model User {
  id          Int      @id @default(autoincrement())
  // Nếu bạn dùng Supabase Auth, lưu id của user (UUID) tại đây để liên kết profile
  // (ví dụ: 'supabaseId' sẽ chứa giá trị UUID do Supabase cấp). Trường này để
  // tùy chọn để vẫn hỗ trợ user cục bộ không dùng Supabase.
  // Lưu ý: với Postgres/Supabase trường này dùng native UUID để tương thích với
  // id do Supabase cấp. Đây là kiểu chỉ hỗ trợ với Postgres connector.
  supabaseId  String?  @unique @db.Uuid
  email       String   @unique
  name        String?
  avatarUrl   String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  addresses   String?
  phoneNumber String?

  // Roles: many-to-many via UserRoleAssignment
  roleAssignments UserRoleAssignment[]
  // Quyền gán trực tiếp cho user (nếu có)
  userPermissions UserPermission[]

  // Relations với Post và Category
  createdPosts        Post[]         @relation("PostCreatedBy")
  updatedPosts        Post[]         @relation("PostUpdatedBy")
  createdCategories   PostCategory[] @relation("CategoryCreatedBy")
  updatedCategories   PostCategory[] @relation("CategoryUpdatedBy")
  createdSeoMeta      SeoMeta[]      @relation("SeoCreatedBy")
  updatedSeoMeta      SeoMeta[]      @relation("SeoUpdatedBy")
  createdPostComments PostComment[]  @relation("PostCommentCreatedBy")
  updatedPostComments PostComment[]  @relation("PostCommentUpdatedBy")
  userComments        PostComment[]  @relation("UserComments")

  @@map("users")
}

// UserRole: lưu các vai trò (role) có thể mở rộng (ví dụ: admin, user, support)
model UserRole {
  id          Int     @id @default(autoincrement())
  key         String  @unique // machine-friendly key, e.g. 'admin'
  name        String // human-friendly name
  description String?

  assignments     UserRoleAssignment[]
  // Quyền gán cho role
  rolePermissions RolePermission[]

  @@map("user_roles")
}

// Bảng nối many-to-many giữa User và UserRole
model UserRoleAssignment {
  id     Int      @id @default(autoincrement())
  user   User     @relation(fields: [userId], references: [id])
  userId Int
  role   UserRole @relation(fields: [roleId], references: [id])
  roleId Int
  // tùy chọn: dùng để phân vùng vai trò theo tổ chức hoặc resource trong tương lai
  scope  String?

  @@unique([userId, roleId, scope])
  @@map("user_role_assignments")
}

// -------------------------
// Quyền (Permissions)
// -------------------------
// Permission: định nghĩa các chức năng cụ thể trong hệ thống, ví dụ: 'user.view',
// 'user.edit', 'project.create'. Mỗi permission có key duy nhất và mô tả để tránh nhầm lẫn.
model Permission {
  id          Int     @id @default(autoincrement())
  key         String  @unique // ví dụ: 'user.view'
  name        String // ví dụ: 'Xem người dùng'
  description String? // mô tả chi tiết quyền

  // Các mapping
  rolePermissions RolePermission[]
  userPermissions UserPermission[]

  @@map("permissions")
}

// RolePermission: gán permission cho role (nhiều role <-> nhiều permission)
model RolePermission {
  id           Int        @id @default(autoincrement())
  role         UserRole   @relation(fields: [roleId], references: [id])
  roleId       Int
  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId Int

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// UserPermission: tùy chọn để gán permission trực tiếp cho user (ghi đè hoặc bổ sung)
model UserPermission {
  id           Int        @id @default(autoincrement())
  user         User       @relation(fields: [userId], references: [id])
  userId       Int
  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId Int
  // allowed = true => cho phép, false => tắt quyền (dùng để ghi đè)
  allowed      Boolean    @default(true)

  @@unique([userId, permissionId])
  @@map("user_permissions")
}

// Model PostCategory
model PostCategory {
  id          Int     @id @default(autoincrement())
  name        String
  slug        String  @unique
  description String?
  parentId    Int? // Self-reference cho category con
  active      Boolean @default(true)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy Int
  updatedBy Int

  // Relations
  taggedPosts Post[]         @relation("PostTaggedCategories")
  creator     User           @relation("CategoryCreatedBy", fields: [createdBy], references: [id])
  updater     User           @relation("CategoryUpdatedBy", fields: [updatedBy], references: [id])
  parent      PostCategory?  @relation("CategoryParent", fields: [parentId], references: [id])
  children    PostCategory[] @relation("CategoryParent")
  posts       Post[]         @relation("PostPrimaryCategory")

  // Note: SEO metadata handled via polymorphic SeoMeta table with seoableType='POST_CATEGORY'

  @@map("post_categories")
}

// Model Post
model Post {
  id            Int        @id @default(autoincrement())
  title         String
  slug          String     @unique
  excerpt       String?
  content       String
  featuredImage String?
  status        PostStatus @default(DRAFT)

  albumImages Json? // Array URLs: ["img1.jpg", "img2.jpg", "img3.jpg"]
  videoUrl    String? // URL video YouTube/Vimeo cho video tutorials

  // Content Enhancement  
  note String? // Ghi chú nội bộ cho editor/admin

  // Content Organization
  priority      Int     @default(0) // Độ ưu tiên hiển thị (0=normal, 1=high, 2=urgent)
  isHighlighted Boolean @default(false) // Bài viết nổi bật
  isFeatured    Boolean @default(false) // Hiển thị ở homepage/featured section

  // Publishing Control
  scheduledAt DateTime? // Đăng theo lịch (scheduled publishing)
  expiredAt   DateTime? // Ngày hết hạn (cho tin khuyến mãi)

  // Insurance Specific
  targetAudience  Json? // ["individual", "business", "family"] - đối tượng mục tiêu
  relatedProducts Json? // [1, 2, 3] - IDs của sản phẩm bảo hiểm liên quan

  // Content Metadata
  metaKeywords Json? // Keywords for internal search

  publishedAt DateTime?
  categoryId  Int?

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy Int
  updatedBy Int

  // Relations
  creator  User          @relation("PostCreatedBy", fields: [createdBy], references: [id])
  updater  User          @relation("PostUpdatedBy", fields: [updatedBy], references: [id])
  category PostCategory? @relation("PostPrimaryCategory", fields: [categoryId], references: [id])

  taggedCategories PostCategory[] @relation("PostTaggedCategories") // Mối quan hệ với thẻ bài viết
  comments         PostComment[]  @relation("PostComments") // Comments của post
  postType         PostType       @default(ARTICLE) // ARTICLE, GUIDE, NEWS, PRODUCT

  // Note: SEO metadata handled via polymorphic SeoMeta table with seoableType='POST'

  @@map("posts")
}

// model PostTag {
//   id    Int    @id @default(autoincrement()) // ID thẻ
//   name  String // Tên thẻ
//   slug  String @unique // URL thân thiện của thẻ

//   posts Post[] @relation("PostTags") // Liên kết với bài viết

//   @@index([slug])
// }

// Model SEO chung cho tất cả
model SeoMeta {
  id          Int         @id @default(autoincrement())
  // Polymorphic fields
  seoableType SeoableType
  seoableId   Int

  // SEO cơ bản
  seoTitle        String? @db.VarChar(120)
  metaDescription String? @db.VarChar(255)
  canonicalUrl    String?
  focusKeyword    String? @db.VarChar(100)

  seoImage String?
  // Riêng MXH chỉ cần thêm loại nội dung Open Graph (cho Facebook, Instagram, Threads)
  ogType   String? @default("article") @db.VarChar(20)

  // Kỹ thuật SEO
  noindex  Boolean @default(false)
  nofollow Boolean @default(false)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy Int
  updatedBy Int
  // Relations
  creator   User     @relation("SeoCreatedBy", fields: [createdBy], references: [id])
  updater   User     @relation("SeoUpdatedBy", fields: [updatedBy], references: [id])

  // Composite unique index cho polymorphic
  @@unique([seoableType, seoableId])
  @@index([seoableType, seoableId])
  @@map("seo_meta")
}

enum PostType {
  ARTICLE // Bài viết thông thường
  GUIDE // Hướng dẫn
  NEWS // Tin tức
  PRODUCT // Giới thiệu sản phẩm bảo hiểm
  FAQ // Câu hỏi thường gặp
}

// Enums
enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum SeoableType {
  POST
  POST_CATEGORY

  // Insurance Products
  PRODUCT
  PRODUCT_CATEGORY
  INSURANCE_PLAN

  // Customer & Reviews  
  REVIEW
  TESTIMONIAL

  // Content & Guides
  CLAIM_GUIDE
  FAQ_ITEM
  LEGAL_PAGE

  // Company Info
  BRANCH_OFFICE
  AGENT_PROFILE

  // Có thể thêm nhiều hơn khi cần
}

model PostComment {
  id        Int      @id @default(autoincrement())
  content   String
  postId    Int
  userId    Int? // nullable cho guest comments
  email     String? // cho guest
  name      String? // cho guest
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy Int
  updatedBy Int

  // Relations
  post    Post  @relation("PostComments", fields: [postId], references: [id])
  user    User? @relation("UserComments", fields: [userId], references: [id])
  creator User  @relation("PostCommentCreatedBy", fields: [createdBy], references: [id])
  updater User  @relation("PostCommentUpdatedBy", fields: [updatedBy], references: [id])

  @@map("post_comments")
}


// npx prisma migrate dev --name add_seo_meta_model
// npx prisma generate
