# API Insurance - Backend REST API

[![Node.js](https://img.shields.io/badge/Node.js-22.x-green.svg)](https://nodejs.org/)
[![TypeScript](https://img.shields.io/badge/TypeScript-5.9.2-blue.svg)](https://www.typescriptlang.org/)
[![Express](https://img.shields.io/badge/Express-5.1.0-lightgrey.svg)](https://expressjs.com/)
[![Prisma](https://img.shields.io/badge/Prisma-6.15.0-2D3748.svg)](https://www.prisma.io/)
[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-Database-316192.svg)](https://www.postgresql.org/)
[![License](https://img.shields.io/badge/License-ISC-green.svg)](LICENSE)

**API Insurance** l√† backend REST API cho h·ªá th·ªëng qu·∫£n l√Ω b·∫£o hi·ªÉm, ƒë∆∞·ª£c x√¢y d·ª±ng v·ªõi Node.js, Express, TypeScript v√† Prisma ORM. API cung c·∫•p ƒë·∫ßy ƒë·ªß ch·ª©c nƒÉng cho website b·∫£o hi·ªÉm bao g·ªìm authentication, qu·∫£n l√Ω s·∫£n ph·∫©m, b√†i vi·∫øt, menu ƒë·ªông, upload files, v√† h·ªá th·ªëng ph√¢n quy·ªÅn chi ti·∫øt.

---

## üìã M·ª•c L·ª•c

- [T√≠nh nƒÉng ch√≠nh](#-t√≠nh-nƒÉng-ch√≠nh)
- [C√¥ng ngh·ªá s·ª≠ d·ª•ng](#-c√¥ng-ngh·ªá-s·ª≠-d·ª•ng)
- [Y√™u c·∫ßu h·ªá th·ªëng](#-y√™u-c·∫ßu-h·ªá-th·ªëng)
- [C√†i ƒë·∫∑t](#-c√†i-ƒë·∫∑t)
- [C·∫•u h√¨nh](#-c·∫•u-h√¨nh)
- [Ch·∫°y ·ª©ng d·ª•ng](#-ch·∫°y-·ª©ng-d·ª•ng)
- [API Documentation](#-api-documentation)
- [Database Schema](#-database-schema)
- [Modules](#-modules)
- [Authentication & Authorization](#-authentication--authorization)
- [File Upload](#-file-upload)
- [Testing](#-testing)
- [Deploy](#-deploy)
- [T√°c gi·∫£](#-t√°c-gi·∫£)

---

## üöÄ T√≠nh nƒÉng ch√≠nh

### ‚úÖ **Authentication & Authorization**

- **JWT Authentication**: ƒêƒÉng nh·∫≠p, ƒëƒÉng k√Ω, refresh token
- **Role-Based Access Control (RBAC)**: 5 roles (super_admin, admin, editor, author, user)
- **Permission System**: 31 permissions chi ti·∫øt cho t·ª´ng ch·ª©c nƒÉng
- **Database-driven Permissions**: Qu·∫£n l√Ω roles/permissions qua database, kh√¥ng hard-code
- **User Assignment**: G√°n roles v√† permissions cho user linh ho·∫°t

### ‚úÖ **Content Management**

- **Posts (Blog)**: CRUD posts v·ªõi SEO, scheduling, featured, highlighted
- **Post Categories**: Category tree v·ªõi parent-child relationships
- **Products**: Qu·∫£n l√Ω 17+ lo·∫°i b·∫£o hi·ªÉm v·ªõi ƒë·∫ßy ƒë·ªß th√¥ng tin
- **Product Reviews**: ƒê√°nh gi√° s·∫£n ph·∫©m t·ª´ kh√°ch h√†ng
- **Comments**: H·ªá th·ªëng comment cho posts
- **SEO Meta**: Qu·∫£n l√Ω SEO metadata cho posts/products

### ‚úÖ **Dynamic Menu System**

- **Menu Categories**: Ph√¢n lo·∫°i menu (header, footer, product menu)
- **Menu Items**: CRUD menu items v·ªõi nested structure
- **Public API**: L·∫•y menu theo category key cho frontend

### ‚úÖ **Vehicle Types Management**

- Qu·∫£n l√Ω lo·∫°i xe (motorcycle, car, truck, etc.)
- H·ªó tr·ª£ t√≠nh ph√≠ b·∫£o hi·ªÉm xe
- CRUD API v·ªõi validation

### ‚úÖ **File Upload & Image Processing**

- **Integration**: T√≠ch h·ª£p v·ªõi File Upload Service external
- **Multiple File Types**: Avatar, documents, post images, insurance docs
- **Image Optimization**: Resize, compress v·ªõi Sharp
- **Folder Management**: T·ª± ƒë·ªông ph√¢n lo·∫°i files theo folders
- **Validation**: Ki·ªÉm tra file size, type

### ‚úÖ **User Management**

- CRUD users v·ªõi avatar upload
- Qu·∫£n l√Ω profile, addresses, phone
- Active/Inactive status
- Role/Permission assignment

### ‚úÖ **Contact Form**

- Submit contact form t·ª´ frontend
- Email validation
- Store contact requests

### ‚úÖ **Monitoring & Reports**

- Health check endpoint
- System uptime
- Database statistics (pending implementation)

### ‚úÖ **API Documentation**

- **Swagger UI**: Interactive API docs t·∫°i `/docs`
- **OpenAPI 3.0**: Chu·∫©n OpenAPI specification
- **JWT Authentication**: Test API tr·ª±c ti·∫øp v·ªõi token

---

## üõ†Ô∏è C√¥ng ngh·ªá s·ª≠ d·ª•ng

### **Backend Framework**

- **Node.js 22.x**: JavaScript runtime
- **Express 5.1.0**: Web framework
- **TypeScript 5.9.2**: Type-safe development
- **Serverless HTTP 4.0.0**: Deploy tr√™n Vercel serverless

### **Database & ORM**

- **PostgreSQL**: Relational database (Supabase)
- **Prisma 6.15.0**: Modern ORM cho TypeScript
- **Prisma Client**: Type-safe database queries
- **Migrations**: Database schema versioning

### **Authentication & Security**

- **JWT (jsonwebtoken 9.0.2)**: Token-based authentication
- **bcryptjs 3.0.2**: Password hashing
- **CORS 2.8.5**: Cross-Origin Resource Sharing
- **Rate Limiting**: B·∫£o v·ªá API kh·ªèi abuse (custom middleware)

### **File Upload & Processing**

- **Multer 2.0.2**: Handle multipart/form-data
- **Sharp 0.34.3**: Image processing v√† optimization
- **Axios 1.11.0**: HTTP client cho external file service
- **Form-Data 4.0.4**: G·ª≠i files ƒë·∫øn upload service

### **API Documentation**

- **Swagger JSDoc 6.2.8**: Generate OpenAPI t·ª´ JSDoc comments
- **Swagger UI Express 5.0.1**: Interactive API documentation UI

### **Utilities**

- **Slugify 1.6.6**: T·∫°o URL-friendly slugs
- **dotenv 17.2.2**: Environment variables management
- **http-status-codes 2.3.0**: HTTP status constants

### **Development Tools**

- **Nodemon 3.1.10**: Auto-restart server khi dev
- **ESLint 9.34.0**: Linting
- **Prettier 3.6.2**: Code formatter
- **TypeScript ESLint 8.42.0**: TypeScript linting rules
- **tsc-alias 1.8.16**: Resolve TypeScript path aliases
- **rimraf 6.0.1**: Cross-platform rm -rf

---

## üì¶ Y√™u c·∫ßu h·ªá th·ªëng

- **Node.js**: >= 22.x (required by engines in package.json)
- **npm**: >= 9.x ho·∫∑c **yarn** / **pnpm**
- **PostgreSQL**: >= 14.x (ho·∫∑c Supabase)
- **RAM**: T·ªëi thi·ªÉu 2GB (khuy·∫øn ngh·ªã 4GB)
- **Disk Space**: ~200MB cho node_modules

---

## üì• C√†i ƒë·∫∑t

### 1. Clone Repository

```bash
git clone https://github.com/your-username/api-insurance.git
cd api-insurance
```

### 2. C√†i ƒë·∫∑t Dependencies

```bash
npm install
# ho·∫∑c
yarn install
```

### 3. Setup Database

T·∫°o database PostgreSQL (local ho·∫∑c Supabase):

```sql
CREATE DATABASE insurance_db;
```

### 4. C·∫•u h√¨nh Environment

T·∫°o file `.env` t·ª´ `.env.example`:

```bash
cp .env.example .env
```

ƒêi·ªÅn th√¥ng tin v√†o `.env` (xem ph·∫ßn [C·∫•u h√¨nh](#-c·∫•u-h√¨nh) b√™n d∆∞·ªõi).

### 5. Ch·∫°y Migrations

```bash
npx prisma migrate dev
```

### 6. Seed Database (Optional)

```bash
# Seed roles & permissions
npm run seed:roles

# T·∫°o admin user m·∫∑c ƒë·ªãnh
npm run create:admin

# Ho·∫∑c seed t·∫•t c·∫£
npx prisma db seed
```

---

## ‚öôÔ∏è C·∫•u h√¨nh

T·∫°o file `.env` trong th∆∞ m·ª•c g·ªëc:

```env
# Server Configuration
PORT=3600
NODE_ENV=development

# Database (PostgreSQL - Supabase ho·∫∑c local)
DATABASE_URL="postgresql://user:password@host:5432/insurance_db?schema=public"

# JWT Authentication
JWT_SECRET=your_super_secret_jwt_key_here_change_in_production
JWT_REFRESH_SECRET=your_refresh_token_secret_here
JWT_ACCESS_EXPIRATION=15m
JWT_REFRESH_EXPIRATION=7d

# CORS - Frontend URLs (comma-separated)
CLIENT_ORIGIN=http://localhost:4600,https://xtbh.tranxuanthanhtxt.com

# File Upload Service (External)
FILE_UPLOAD_BASE_URL=https://file-fastify.tranxuanthanhtxt.com/api/files
IMAGE_UPLOAD_KEY=your_upload_service_api_key

# Supabase (Optional - n·∫øu d√πng Supabase Auth)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# Email Service (Optional - cho future features)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your_email@gmail.com
SMTP_PASS=your_app_password

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100
```

**L∆∞u √Ω quan tr·ªçng**:

- File `.env` ƒë√£ ƒë∆∞·ª£c th√™m v√†o `.gitignore`, **KH√îNG commit l√™n Git**
- ƒê·ªïi `JWT_SECRET` v√† `JWT_REFRESH_SECRET` trong production
- `DATABASE_URL`: L·∫•y t·ª´ Supabase ho·∫∑c PostgreSQL local
- `IMAGE_UPLOAD_KEY`: API key t·ª´ file upload service

---

## üéØ Ch·∫°y ·ª©ng d·ª•ng

### **Development Mode**

```bash
npm run dev
```

Server ch·∫°y tr√™n `http://localhost:3600` (ho·∫∑c PORT trong .env)

Nodemon s·∫Ω t·ª± ƒë·ªông restart khi c√≥ thay ƒë·ªïi code.

---

### **Production Mode**

#### 1. Build

```bash
npm run build
```

Output: `dist/` folder v·ªõi compiled JavaScript.

#### 2. Start Production Server

```bash
npm start
```

---

### **Database Commands**

#### Prisma Migrations

```bash
# T·∫°o migration m·ªõi
npx prisma migrate dev --name your_migration_name

# Apply migrations (production)
npx prisma migrate deploy

# Reset database (‚ö†Ô∏è X√ìA T·∫§T C·∫¢ D·ªÆ LI·ªÜU)
npx prisma migrate reset
```

#### Prisma Studio (Database GUI)

```bash
npx prisma studio
```

M·ªü tr√¨nh duy·ªát t·∫°i `http://localhost:5555` ƒë·ªÉ qu·∫£n l√Ω database tr·ª±c quan.

#### Generate Prisma Client

```bash
npx prisma generate
```

---

### **Seed & Setup Commands**

```bash
# Setup authentication system
npm run setup:auth

# Seed roles & permissions
npm run seed:roles

# T·∫°o admin user m·∫∑c ƒë·ªãnh
npm run create:admin
```

---

### **Linting & Formatting**

```bash
# Ki·ªÉm tra ESLint
npm run lint

# Auto-fix ESLint errors
npm run lint:fix

# Ki·ªÉm tra Prettier
npm run prettier

# Auto-format v·ªõi Prettier
npm run prettier:fix
```

---

## üìö API Documentation

### **Swagger UI (Interactive Docs)**

**URL**: [https://api-insurance.tranxuanthanhtxt.com/docs](https://api-insurance.tranxuanthanhtxt.com/docs)

Swagger UI cung c·∫•p:

- Danh s√°ch t·∫•t c·∫£ endpoints
- Request/Response schemas
- Th·ª≠ nghi·ªám API tr·ª±c ti·∫øp v·ªõi JWT token
- Examples cho m·ªói endpoint

### **S·ª≠ d·ª•ng Swagger UI:**

1. M·ªü [/docs](https://api-insurance.tranxuanthanhtxt.com/docs)
2. Click **"Authorize"** button (üîì icon)
3. Nh·∫≠p JWT token: `Bearer <your_token_here>`
4. Click **"Authorize"** ƒë·ªÉ l∆∞u
5. Test c√°c endpoints b·∫±ng c√°ch click **"Try it out"**

### **L·∫•y JWT Token:**

```bash
POST /api/auth/login
Content-Type: application/json

{
  "email": "admin@example.com",
  "password": "admin123"
}

# Response:
{
  "status": true,
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "...",
    "user": { ... }
  }
}
```

Copy `accessToken` v√† d√πng trong Swagger UI.

---

## üóÑÔ∏è Database Schema

### **Core Models**

#### **User**

- `id`, `email`, `name`, `avatarUrl`, `phoneNumber`, `addresses`
- `active`, `supabaseId` (optional)
- Relationships: roles, permissions, created posts/products

#### **UserRole**

- `id`, `key`, `name`, `description`
- Pre-defined: `super_admin`, `admin`, `editor`, `author`, `user`

#### **Permission**

- `id`, `key`, `name`, `description`
- 31 permissions: post._, user._, role._, admin._, content._, seo._, comment.\*

#### **UserRoleAssignment**

- Links User ‚Üî UserRole
- Supports `scope` for fine-grained permissions

#### **UserPermission**

- Direct user-level permissions (override role permissions)
- `allowed` flag (true/false)

### **Content Models**

#### **Post**

- `id`, `title`, `slug`, `content`, `excerpt`, `featuredImage`
- `status` (DRAFT, PUBLISHED, ARCHIVED)
- `isHighlighted`, `isFeatured`, `priority`
- `scheduledAt`, `publishedAt`, `expiredAt`
- `albumImages` (JSON), `videoUrl`
- SEO: via `SeoMeta` relation

#### **PostCategory**

- `id`, `name`, `slug`, `description`, `parentId`
- Tree structure v·ªõi parent-child
- `order`, `active`

#### **Product**

- `id`, `name`, `slug`, `description`, `shortDescription`
- `price`, `originalPrice`, `currency`
- `featuredImage`, `galleryImages` (JSON)
- `stock`, `sku`, `featured`, `newArrival`
- `categoryId`, `tags` (JSON)

#### **ProductReview**

- `id`, `productId`, `userId`, `rating`, `comment`
- `verified`, `helpful`

#### **PostComment**

- `id`, `postId`, `userId`, `content`, `parentId`
- Tree structure cho nested comments
- `approved`

#### **SeoMeta**

- `id`, `seoableType`, `seoableId`
- `seoTitle`, `metaDescription`, `canonicalUrl`
- `focusKeyword`, `ogType`
- `noindex`, `nofollow`

### **Menu System**

#### **MenuCategory**

- `id`, `name`, `key`, `description`
- Examples: `menu-header`, `menu-footer`, `menu-product`

#### **MenuItem**

- `id`, `categoryId`, `label`, `url`, `icon`
- `parentId` (tree structure), `order`, `target`
- `active`

### **Vehicle Types**

#### **VehicleType**

- `id`, `name`, `description`, `categoryKey`
- `order`, `active`
- Examples: motorcycle, car, truck, bus

### **Contact**

#### **Contact**

- `id`, `name`, `email`, `phoneNumber`, `subject`, `message`
- `status`, `note`, `priority`

---

## üß© Modules

API ƒë∆∞·ª£c t·ªï ch·ª©c th√†nh **13 modules** ch√≠nh:

### **1. Auth Module** (`/api/auth`)

| Endpoint    | Method | M√¥ t·∫£                        |
| ----------- | ------ | ---------------------------- |
| `/login`    | POST   | ƒêƒÉng nh·∫≠p (email + password) |
| `/register` | POST   | ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi        |
| `/refresh`  | POST   | Refresh access token         |
| `/logout`   | POST   | ƒêƒÉng xu·∫•t                    |
| `/profile`  | GET    | L·∫•y th√¥ng tin user hi·ªán t·∫°i  |

### **2. Users Module** (`/api/users`)

| Endpoint | Method | M√¥ t·∫£                    | Permission    |
| -------- | ------ | ------------------------ | ------------- |
| `/`      | GET    | List users               | `user.view`   |
| `/`      | POST   | Create user (v·ªõi avatar) | `user.create` |
| `/:id`   | GET    | Get user by ID           | `user.view`   |
| `/:id`   | PATCH  | Update user              | `user.edit`   |
| `/:id`   | DELETE | Delete user              | `user.delete` |

### **3. Posts Module** (`/api/posts`)

| Endpoint       | Method | M√¥ t·∫£               | Permission     |
| -------------- | ------ | ------------------- | -------------- |
| `/`            | GET    | List posts (public) | -              |
| `/`            | POST   | Create post         | `post.create`  |
| `/:id`         | GET    | Get post by ID      | -              |
| `/slug/:slug`  | GET    | Get post by slug    | -              |
| `/:id`         | PATCH  | Update post         | `post.edit`    |
| `/:id`         | DELETE | Delete post         | `post.delete`  |
| `/:id/publish` | POST   | Publish post        | `post.publish` |

### **4. Post Categories Module** (`/api/post-categories`)

| Endpoint | Method | M√¥ t·∫£                  | Permission             |
| -------- | ------ | ---------------------- | ---------------------- |
| `/`      | GET    | List categories (tree) | -                      |
| `/`      | POST   | Create category        | `post_category.create` |
| `/:id`   | PATCH  | Update category        | `post_category.edit`   |
| `/:id`   | DELETE | Delete category        | `post_category.delete` |

### **5. Products Module** (`/api/products`)

| Endpoint      | Method | M√¥ t·∫£                          |
| ------------- | ------ | ------------------------------ |
| `/`           | GET    | List products                  |
| `/sorted`     | GET    | List products with pagination  |
| `/home`       | GET    | Featured products for homepage |
| `/:id`        | GET    | Get product by ID              |
| `/slug/:slug` | GET    | Get product by slug            |
| `/:id`        | PATCH  | Update product                 |
| `/:id`        | DELETE | Delete product                 |

### **6. Menus Module** (`/api/menus`)

| Endpoint       | Method | M√¥ t·∫£                           |
| -------------- | ------ | ------------------------------- |
| `/categories`  | GET    | List menu categories            |
| `/categories`  | POST   | Create menu category            |
| `/public/:key` | GET    | Get public menu by category key |
| `/items`       | GET    | List menu items                 |
| `/items`       | POST   | Create menu item                |
| `/items/:id`   | PATCH  | Update menu item                |
| `/items/:id`   | DELETE | Delete menu item                |

### **7. Vehicle Types Module** (`/api/vehicle-types`)

| Endpoint | Method | M√¥ t·∫£               |
| -------- | ------ | ------------------- |
| `/`      | GET    | List vehicle types  |
| `/`      | POST   | Create vehicle type |
| `/:id`   | PATCH  | Update vehicle type |
| `/:id`   | DELETE | Delete vehicle type |

### **8. Permissions Module** (`/api/permissions`)

| Endpoint | Method | M√¥ t·∫£             | Permission          |
| -------- | ------ | ----------------- | ------------------- |
| `/`      | GET    | List permissions  | `permission.view`   |
| `/`      | POST   | Create permission | `permission.manage` |

### **9. User Roles Module** (`/api/user-roles`)

| Endpoint           | Method | M√¥ t·∫£                | Permission    |
| ------------------ | ------ | -------------------- | ------------- |
| `/`                | GET    | List roles           | `role.view`   |
| `/`                | POST   | Create role          | `role.create` |
| `/:id/permissions` | GET    | Get role permissions | `role.view`   |

### **10. User Assignments Module** (`/api/user-assignments`)

| Endpoint               | Method | M√¥ t·∫£                |
| ---------------------- | ------ | -------------------- |
| `/`                    | POST   | Assign role to user  |
| `/:userId/roles`       | GET    | Get user roles       |
| `/:userId/permissions` | GET    | Get user permissions |

### **11. Contact Module** (`/api/contact`)

| Endpoint | Method | M√¥ t·∫£                      |
| -------- | ------ | -------------------------- |
| `/`      | POST   | Submit contact form        |
| `/`      | GET    | List contacts (admin only) |

### **12. Reports Module** (`/api/reports`)

| Endpoint | Method | M√¥ t·∫£                           |
| -------- | ------ | ------------------------------- |
| `/`      | GET    | Get system statistics (pending) |

### **13. Monitoring** (`/api/health`)

| Endpoint  | Method | M√¥ t·∫£                          |
| --------- | ------ | ------------------------------ |
| `/health` | GET    | Health check (status + uptime) |

---

## üîê Authentication & Authorization

### **JWT Authentication Flow**

1. **Login**: User g·ª≠i email + password ‚Üí Server tr·∫£ v·ªÅ `accessToken` v√† `refreshToken`
2. **Authenticated Requests**: Frontend g·ª≠i `Authorization: Bearer <accessToken>` trong headers
3. **Token Expiration**: Khi `accessToken` h·∫øt h·∫°n (15 ph√∫t), d√πng `refreshToken` ƒë·ªÉ l·∫•y token m·ªõi
4. **Logout**: X√≥a tokens kh·ªèi client

### **Role-Based Access Control (RBAC)**

#### **5 Roles m·∫∑c ƒë·ªãnh:**

| Role          | Permissions          | M√¥ t·∫£                             |
| ------------- | -------------------- | --------------------------------- |
| `super_admin` | 31 permissions (ALL) | To√†n quy·ªÅn h·ªá th·ªëng               |
| `admin`       | 21 permissions       | Qu·∫£n l√Ω content + users           |
| `editor`      | 16 permissions       | Qu·∫£n l√Ω content (posts, products) |
| `author`      | 6 permissions        | T·∫°o/s·ª≠a posts c·ªßa m√¨nh            |
| `user`        | 3 permissions        | Xem n·ªôi dung, comment             |

#### **31 Permissions:**

**Post Category**: `post_category.view`, `post_category.create`, `post_category.edit`, `post_category.delete`, `post_category.manage`

**Post**: `post.view`, `post.create`, `post.edit`, `post.delete`, `post.publish`, `post.manage`

**User**: `user.view`, `user.create`, `user.edit`, `user.delete`, `user.manage`

**Role**: `role.view`, `role.create`, `role.edit`, `role.delete`, `role.manage`

**System**: `admin.access`, `system.config`, `permission.view`, `permission.manage`

**Content**: `content.moderate`, `content.publish`, `seo.manage`

**Comment**: `comment.view`, `comment.moderate`, `comment.delete`

### **Middleware S·ª≠ D·ª•ng:**

```typescript
// authMiddleware.ts
export const authenticate = (req, res, next) => { ... }
export const requirePermission = (permission: string) => { ... }
export const requireRole = (roles: string[]) => { ... }

// S·ª≠ d·ª•ng trong routes:
router.post('/posts',
  authenticate,
  requirePermission('post.create'),
  createPost
)
```

---

## üì§ File Upload

### **Architecture**

API t√≠ch h·ª£p v·ªõi **External File Upload Service** (kh√¥ng t·ª± host files):

```
Client ‚Üí API ‚Üí File Upload Service (file-fastify.tranxuanthanhtxt.com)
```

### **Upload Flow**

1. Client g·ª≠i file qua multipart/form-data ƒë·∫øn API
2. API s·ª≠ d·ª•ng Multer ƒë·ªÉ parse file
3. API forward file ƒë·∫øn Upload Service qua Axios
4. Upload Service x·ª≠ l√Ω, optimize, l∆∞u file, tr·∫£ v·ªÅ URL
5. API l∆∞u URL v√†o database (avatarUrl, featuredImage, etc.)

### **Supported Upload Types**

| Type           | Max Size | Folder       | Allowed Formats           |
| -------------- | -------- | ------------ | ------------------------- |
| Avatar         | 5MB      | `avatars/`   | jpg, jpeg, png, gif, webp |
| Post Images    | 10MB     | `posts/`     | jpg, jpeg, png, gif, webp |
| Product Images | 10MB     | `products/`  | jpg, jpeg, png, gif, webp |
| Documents      | 10MB     | `documents/` | pdf, doc, docx, xls, xlsx |
| Insurance Docs | 10MB     | `insurance/` | pdf, jpg, png             |

### **Services & Helpers**

```typescript
// src/services/fileUploadService.ts
class FileUploadService {
  uploadSingleFile(buffer, name, options)
  uploadMultipleFiles(files, options)
  uploadAvatar(buffer, name)
  uploadDocument(buffer, name, folder)
}

// src/services/uploadHelpers.ts
class UploadHelpers {
  uploadPostImages(files)
  uploadUserDocuments(files)
  uploadInsuranceDocuments(files)
}
```

### **Image Processing**

- **Sharp**: Resize, compress, optimize images tr∆∞·ªõc khi upload
- **WebP Conversion**: T·ª± ƒë·ªông convert sang WebP (n·∫øu c·∫ßn)
- **Thumbnails**: T·∫°o thumbnail cho gallery images

### **Configuration**

```env
FILE_UPLOAD_BASE_URL=https://file-fastify.tranxuanthanhtxt.com/api/files
IMAGE_UPLOAD_KEY=your_api_key
```

---

## üß™ Testing

### **Unit Tests**

(Ch∆∞a tri·ªÉn khai - TODO)

Khuy·∫øn ngh·ªã s·ª≠ d·ª•ng:

- **Jest**: `npm install --save-dev jest @types/jest ts-jest`
- **Supertest**: Testing HTTP requests

```bash
# Ch·∫°y tests
npm test

# Coverage
npm run test:coverage
```

### **Manual Testing**

- **Swagger UI**: Test API tr·ª±c ti·∫øp t·∫°i `/docs`
- **Postman**: Import OpenAPI spec t·ª´ `/swagger.json`
- **cURL**: Examples trong `docs/` folder

---

## üöÄ Deploy

### **Deploy l√™n Vercel (Serverless)**

#### 1. **C·∫•u h√¨nh Vercel**

File `vercel.json` ƒë√£ c√≥ s·∫µn:

```json
{
  "version": 2,
  "builds": [{ "src": "api/index.js", "use": "@vercel/node" }],
  "routes": [
    { "src": "/docs", "dest": "api/index.js" },
    { "src": "/swagger.json", "dest": "api/index.js" },
    { "src": "/(.*)", "dest": "api/index.js" }
  ]
}
```

#### 2. **Deploy Steps**

```bash
# Install Vercel CLI
npm i -g vercel

# Login
vercel login

# Deploy
vercel --prod
```

#### 3. **Environment Variables tr√™n Vercel**

Th√™m c√°c bi·∫øn trong Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables:

- `DATABASE_URL`
- `JWT_SECRET`
- `JWT_REFRESH_SECRET`
- `CLIENT_ORIGIN`
- `FILE_UPLOAD_BASE_URL`
- `IMAGE_UPLOAD_KEY`

#### 4. **Build Command**

Vercel t·ª± ƒë·ªông ch·∫°y:

```bash
npm run vercel-build
```

### **Deploy l√™n VPS/Server**

#### 1. **Build**

```bash
npm run build
```

#### 2. **Start v·ªõi PM2**

```bash
npm install -g pm2

pm2 start dist/index.js --name api-insurance
pm2 save
pm2 startup
```

#### 3. **Nginx Reverse Proxy**

```nginx
server {
    listen 80;
    server_name api.yourdomain.com;

    location / {
        proxy_pass http://localhost:3600;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

#### 4. **SSL v·ªõi Certbot**

```bash
sudo certbot --nginx -d api.yourdomain.com
```

---

## üìÇ C·∫•u tr√∫c D·ª± √°n

```
api-insurance/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts                 # Entry point
‚îÇ   ‚îú‚îÄ‚îÄ bases/                   # Base classes/utilities
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ swagger.ts          # Swagger configuration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ axiosClient.ts      # Axios instances
‚îÇ   ‚îú‚îÄ‚îÄ middlewares/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authMiddleware.ts   # JWT authentication
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authUtils.ts        # Auth utilities
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rateLimit.ts        # Rate limiting
‚îÇ   ‚îú‚îÄ‚îÄ modules/                # Feature modules
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/               # Login, register, refresh
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users/              # User management
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ posts/              # Blog posts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ postCategories/     # Post categories
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ products/           # Products
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ menus/              # Dynamic menus
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vehicleTypes/       # Vehicle types
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ permissions/        # Permissions CRUD
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ userRoles/          # Roles CRUD
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ userAssignments/    # Role assignments
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contact/            # Contact form
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reports/            # System reports
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ monitoring/         # Health checks
‚îÇ   ‚îú‚îÄ‚îÄ router/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts            # Route registration
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fileUploadService.ts    # File upload integration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ uploadHelpers.ts        # Upload utilities
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ imageProcessingService.ts # Sharp image processing
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ seoService.ts           # SEO utilities
‚îÇ   ‚îú‚îÄ‚îÄ schemas/                # Validation schemas (Zod/Joi)
‚îÇ   ‚îú‚îÄ‚îÄ types/                  # TypeScript type definitions
‚îÇ   ‚îú‚îÄ‚îÄ utils/                  # Helper functions
‚îÇ   ‚îî‚îÄ‚îÄ scripts/                # Seed & setup scripts
‚îÇ       ‚îú‚îÄ‚îÄ setupAuth.ts
‚îÇ       ‚îú‚îÄ‚îÄ seedRolesPermissions.ts
‚îÇ       ‚îî‚îÄ‚îÄ createDefaultAdmin.ts
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma           # Database schema
‚îÇ   ‚îú‚îÄ‚îÄ migrations/             # Migration history
‚îÇ   ‚îú‚îÄ‚îÄ seed.ts                 # Main seed file
‚îÇ   ‚îú‚îÄ‚îÄ seedUsers.ts
‚îÇ   ‚îú‚îÄ‚îÄ seedPostCategories.ts
‚îÇ   ‚îú‚îÄ‚îÄ seedPosts.ts
‚îÇ   ‚îú‚îÄ‚îÄ seedVehicleTypes.ts
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ docs/                       # Technical documentation
‚îÇ   ‚îú‚îÄ‚îÄ auth-implementation-summary.md
‚îÇ   ‚îú‚îÄ‚îÄ user-api-examples.md
‚îÇ   ‚îú‚îÄ‚îÄ file-upload-service.md
‚îÇ   ‚îú‚îÄ‚îÄ performance-optimization-*.md
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ index.js                # Vercel serverless entry
‚îú‚îÄ‚îÄ dist/                       # Build output (generated)
‚îú‚îÄ‚îÄ generated/
‚îÇ   ‚îî‚îÄ‚îÄ prisma/                 # Generated Prisma client
‚îú‚îÄ‚îÄ .env                        # Environment variables (not in git)
‚îú‚îÄ‚îÄ .env.example                # Example env file
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ tsconfig.build.json
‚îú‚îÄ‚îÄ vercel.json                 # Vercel config
‚îú‚îÄ‚îÄ nodemon.json                # Nodemon config
‚îî‚îÄ‚îÄ README.md                   # This file
```

---

## üìú Scripts Quan Tr·ªçng

| Script                 | M√¥ t·∫£                                      |
| ---------------------- | ------------------------------------------ |
| `npm run dev`          | Ch·∫°y dev server v·ªõi Nodemon (auto-restart) |
| `npm run build`        | Build production (TypeScript ‚Üí JavaScript) |
| `npm start`            | Ch·∫°y production server t·ª´ `dist/`          |
| `npm run vercel-build` | Build cho Vercel deployment                |
| `npm run lint`         | Ki·ªÉm tra ESLint                            |
| `npm run lint:fix`     | Auto-fix ESLint errors                     |
| `npm run prettier`     | Ki·ªÉm tra Prettier format                   |
| `npm run prettier:fix` | Auto-format code                           |
| `npm run setup:auth`   | Setup auth system (roles + permissions)    |
| `npm run seed:roles`   | Seed roles & permissions v√†o DB            |
| `npm run create:admin` | T·∫°o admin user m·∫∑c ƒë·ªãnh                    |

---

## üìö T√†i li·ªáu B·ªï sung

Xem th∆∞ m·ª•c `docs/` cho c√°c h∆∞·ªõng d·∫´n chi ti·∫øt:

| File                             | N·ªôi dung                              |
| -------------------------------- | ------------------------------------- |
| `auth-implementation-summary.md` | H·ªá th·ªëng authentication & permissions |
| `auth-middleware-guide.md`       | H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng auth middleware     |
| `user-api-examples.md`           | Examples t·∫°o/update user v·ªõi avatar   |
| `file-upload-service.md`         | H∆∞·ªõng d·∫´n upload files                |
| `image-processing.md`            | X·ª≠ l√Ω ·∫£nh v·ªõi Sharp                   |
| `seo-workflow.md`                | Workflow qu·∫£n l√Ω SEO                  |
| `performance-optimization-*.md`  | T·ªëi ∆∞u performance                    |
| `rollback-pattern.md`            | Rollback patterns cho transactions    |

---

## üêõ Troubleshooting

### **Database Connection Failed**

```bash
# Ki·ªÉm tra DATABASE_URL trong .env
# Ki·ªÉm tra PostgreSQL/Supabase running
npx prisma db pull  # Test connection
```

### **Prisma Generate Failed**

```bash
# X√≥a generated folder v√† generate l·∫°i
rm -rf generated/
npx prisma generate
```

### **Port Already in Use**

```bash
# ƒê·ªïi PORT trong .env
PORT=3601
```

### **CORS Errors**

```bash
# Th√™m frontend URL v√†o CLIENT_ORIGIN trong .env
CLIENT_ORIGIN=http://localhost:4600,https://your-frontend.com
```

### **JWT Token Invalid**

- Ki·ªÉm tra `JWT_SECRET` trong .env gi·ªëng production
- Ki·ªÉm tra token expiration (default 15 ph√∫t)
- S·ª≠ d·ª•ng `/api/auth/refresh` ƒë·ªÉ l·∫•y token m·ªõi

### **File Upload Failed**

- Ki·ªÉm tra `FILE_UPLOAD_BASE_URL` v√† `IMAGE_UPLOAD_KEY` trong .env
- Verify file upload service ƒëang ch·∫°y
- Check file size < limit (5MB avatar, 10MB docs)

---

## ü§ù ƒê√≥ng g√≥p

M·ªçi ƒë√≥ng g√≥p ƒë·ªÅu ƒë∆∞·ª£c ch√†o ƒë√≥n! Vui l√≤ng:

1. Fork repository
2. T·∫°o branch feature: `git checkout -b feature/amazing-feature`
3. Commit changes: `git commit -m 'Add amazing feature'`
4. Push: `git push origin feature/amazing-feature`
5. M·ªü Pull Request

### **Coding Standards**

- S·ª≠ d·ª•ng ESLint v√† Prettier: `npm run lint:fix && npm run prettier:fix`
- Vi·∫øt JSDoc comments cho Swagger
- Tu√¢n th·ªß TypeScript strict mode
- Commit messages: Conventional Commits format

---

## üåê Demo & API Docs

- **API Base URL**: [https://api-insurance.tranxuanthanhtxt.com](https://api-insurance.tranxuanthanhtxt.com)
- **Swagger Documentation**: [https://api-insurance.tranxuanthanhtxt.com/docs](https://api-insurance.tranxuanthanhtxt.com/docs)

---

## üìù License

D·ª± √°n n√†y s·ª≠ d·ª•ng license **ISC**.

---

## üë®‚Äçüíª T√°c gi·∫£

**Tr·∫ßn Xu√¢n Th√†nh**

- üìß Email: [tranxuanthanhtxt2002@gmail.com](mailto:tranxuanthanhtxt2002@gmail.com)
- üêô GitHub: [@ThanhXT2002](https://github.com/ThanhXT2002)
- üåê API Demo: [https://api-insurance.tranxuanthanhtxt.com](https://api-insurance.tranxuanthanhtxt.com)
- üìñ Swagger Docs: [https://api-insurance.tranxuanthanhtxt.com/docs](https://api-insurance.tranxuanthanhtxt.com/docs)

---

## üôè Acknowledgments

- [Express.js](https://expressjs.com/) - Fast, minimalist web framework
- [Prisma](https://www.prisma.io/) - Next-generation ORM
- [TypeScript](https://www.typescriptlang.org/) - JavaScript v·ªõi types
- [Swagger](https://swagger.io/) - API documentation
- [Vercel](https://vercel.com/) - Serverless deployment platform

---

## üìû Li√™n h·ªá & H·ªó tr·ª£

N·∫øu c√≥ b·∫•t k·ª≥ c√¢u h·ªèi ho·∫∑c v·∫•n ƒë·ªÅ, vui l√≤ng:

- üìß Email: tranxuanthanhtxt2002@gmail.com
- üêõ Open Issue: [GitHub Issues](https://github.com/ThanhXT2002/api-insurance/issues)
- üìñ Xem Swagger Docs: [https://api-insurance.tranxuanthanhtxt.com/docs](https://api-insurance.tranxuanthanhtxt.com/docs)

---

**üéâ C·∫£m ∆°n b·∫°n ƒë√£ s·ª≠ d·ª•ng API Insurance!**

_Built with ‚ù§Ô∏è using Node.js, Express, TypeScript, and Prisma_
